@using SancionadosSAGB2025.Shared.Catalogos
@using SancionadosSAGB2025.Shared
@inject ISnackbar Snackbar
@inject HttpClient httpClient
@typeparam TItem where TItem : ICatalogo, new()
@if (IsEdit)
{
    <MudDialog Style="width:800px;">
        <TitleContent>
            <MudText Color="Color.Primary" Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.AddCircleOutline" Color="Color.Primary" Class="mb-n1" />
                @Titulo
            </MudText>
        </TitleContent>
        <DialogContent>
            @if (Entidad.Descripcion.Length > 90)
            {
                <MudTextField @bind-Value="@Entidad.Descripcion"                              
                              Lines="4"
                              FullWidth="true"                              
                              Style="resize: none; overflow:hidden; min-height:100px; max-height:none;" />
            }
            else
            {
                <MudTextField @bind-Value="@Descripcion" Lines="2" />
            }

        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancel">Cancelar</MudButton>
            <MudButton Color="Color.Primary" OnClick="EditarEntidad">@(BtnAceptar ?? "Editar")</MudButton>
        </DialogActions>
    </MudDialog>
}
else
{
    <MudDialog Style="width:800px;">
        <TitleContent>
            <MudText Color="Color.Primary" Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.AddCircleOutline" Color="Color.Primary" Class="mb-n1" />
                @Titulo
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudTextField @bind-Value="@Descripcion" Label="Escriba el nombre" />
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancel">Cancelar</MudButton>
            <MudButton Color="Color.Primary" OnClick="AgregarEntidad">@(BtnAceptar ?? "Crear")</MudButton>
        </DialogActions>
    </MudDialog>
}


@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }
    [Parameter]
    public bool IsEdit { get; set; } = false;
    [Parameter]
    public TItem Entidad { get; set; } = new TItem();
    [Parameter]
    public string Titulo { get; set; } = string.Empty;
    [Parameter]
    public string BtnAceptar { get; set; } = string.Empty;
    [Parameter]
    public string MensajeSnackBar { get; set; } = string.Empty;
    [Parameter]
    public string nombreApi { get; set; } = string.Empty;
    [Parameter]
    public string token { get; set; }
    public string Descripcion { get; set; } = string.Empty;
    private void Cancel() => MudDialog.Cancel();
    protected override void OnParametersSet()
    {
        if (IsEdit && Entidad is not null)
            Descripcion = Entidad.Descripcion; // copiar valor original al abrir
    }
    private async Task EditarEntidad()
    {
        Entidad.Descripcion = Descripcion;
        Entidad.Token = token;
        var res = await httpClient.PostAsJsonAsync($"api/Catalogos/{nombreApi}", Entidad);

        if (res.IsSuccessStatusCode)
        {
            var respu = await res.Content.ReadFromJsonAsync<RespuestaApiActualizar>();
            if (respu.estatus == true || respu.mensaje.Contains("REGISTRO ACTUALIZADO CORRECTAMENTE"))
            {
                MudDialog.Close(DialogResult.Ok(Entidad.Descripcion));
                Snackbar.Add($"{MensajeSnackBar} Correctamente", Severity.Success);
            }
            else
            {
                Entidad.Descripcion = string.Empty;
                MudDialog.Close(DialogResult.Ok(Entidad.Descripcion));
                Snackbar.Add("No se pudo actualizar correctamente el dato", Severity.Error);
                Console.WriteLine($"Error: {res.StatusCode}");
            }
        }
        else
        {
            Entidad.Descripcion = string.Empty; 
            MudDialog.Close(DialogResult.Ok(Entidad.Descripcion));
            Snackbar.Add("Algo Pudo Salir Mal", Severity.Error);
            Console.WriteLine($"Error: {res.StatusCode}");
        }        
        
    }

    private void AgregarEntidad()
    {
        Entidad.Descripcion = Descripcion;
        Snackbar.Add($"{MensajeSnackBar ?? "Se creó"} Correctamente", Severity.Success);
        MudDialog.Close(DialogResult.Ok(Entidad.Descripcion));
    }
}
